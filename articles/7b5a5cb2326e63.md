---
title: "ã€GraphQL in Nextjsã€‘nexusã§GraphQLã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆã‚’åŠ¹ç‡çš„ã«è¡ŒãŠã†ï¼"
emoji: "ğŸ’¡"
type: "tech"
topics:
  - "graphql"
  - "nextjs"
  - "react"
  - "apollo"
  - "nexus"
published: true
published_at: "2022-06-06 11:35"
---

ã“ã‚“ã«ã¡ã¯ã€@nerusanã§ã™ã€‚
ä»Šå›ã¯ã€GraphQLã®ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆã§nexusãŒä¾¿åˆ©ã ã£ãŸã®ã§ç´¹ä»‹ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

https://nexusjs.org/



é€šå¸¸ã€GraphQLã‚’åˆ©ç”¨ã™ã‚‹æ™‚ã¯ã€ã‚¹ã‚­ãƒ¼ãƒå®šç¾©è¨€èª(Schma Definition Language)ã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ã™ã‚‹ãŸã‚ã®ãƒªã‚¾ãƒ«ãƒãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™APIã‚’è€ƒãˆã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```ts:schema.ts
import { gql } from 'apollo-server-micro'
// ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
// ã‚¿ã‚¹ã‚¯ã‚’æ‰±ã†å‹
export const typeDefs = gql`
  type Task {
    id: Int
    title: String
    done: Boolean
  }

  type Query {
    tasks: [Task]!
  }
`
```

```ts:resolver.ts
// ãƒªã‚¾ãƒ«ãƒãƒ¼ã®è¨˜è¿°
// ä¸€æ—¦JSONã®å›ºå®šå€¤ã‚’è¿”ã™ãƒ­ã‚¸ãƒƒã‚¯ã«ã—ã¦ã„ã‚‹
export const resolvers = {
  Query: {
    tasks: () => {
      return [
        {
          id: 1,
          title: 'task 1',
          done: false,
        },
        {
          id: 2,
          title: 'task 2',
          done: false,
        },
      ]
    }
  }
}
```

```ts:index.ts
import { ApolloServer } from 'apollo-server-micro'

// apolloserverã«ã‚¹ã‚­ãƒ¼ãƒãƒ¼ã¨ãƒªã‚¾ãƒ«ãƒãƒ¼ã®ã‚»ãƒƒãƒˆ
const server = new ApolloServer({
  typeDefs,
  resolvers,
  csrfPrevention: true,
});

// ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒªãƒƒã‚¹ãƒ³
server.listen().then(({ url }) => {
  console.log(`ğŸš€  Server ready at ${url}`);
});
```

ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰å®šç¾©ã—ã€ãƒªã‚¾ãƒ«ãƒãƒ¼ã‚’å®šç¾©ã™ã‚‹ãŸã‚ã€
ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã—ã°ã—ã°**ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**ã¨å‘¼ã°ã‚Œã¾ã™ã€‚
ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã¯ä»¥ä¸‹ã®æ¬ ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

* ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆã¨ãƒªã‚¾ãƒ«ãƒãƒ¼è¨­è¨ˆãŒç•°ãªã‚‹ã®ã§ã€ä½œæ¥­ãŒé¢å€’ãã•ã„ä¸Šã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå¤§ãããªã‚‹ã«é€£ã‚Œã¦ã€ã‚ã‹ã‚Šã«ãã„
* ã‚¹ã‚­ãƒ¼ãƒè¨€èªã¨ã‚³ãƒ¼ãƒ‰(JavaScript/TypeScript)ã§åŒã˜ã‚ˆã†ãªè¨˜è¿°ãŒç¹°ã‚Šè¿”ã—æ›¸ããŸã‚ã€typoãªã©ã®ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã‚„ã‚„ã™ã„ã—ã€æ°—ã¥ã‹ãªã„
* ã‚¹ã‚­ãƒ¼ãƒè¨€èªã¨JavaScript/TypeScriptã®è¨€èªçš„è¨˜è¿°æ–¹æ³•ãŒç•°ãªã‚‹ã®ã§ã€ç²¾ç¥çš„ã«è‹¦ç—›
* ã‚¨ãƒ‡ã‚£ã‚¿è£œå®ŒãŒåˆ©ç”¨ã§ããªã„

ãã“ã§ã€nexusã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ãã‚Œã‚‰ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹(TypeScript/JavaScript)ã§å®šç¾©ã§ãã‚‹ã®ã§ã€ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã¨å‘¼ã°ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

* GraphQLã®SDL(Schema Definition Language)ã§ã¯ãªãã€ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ(JavaScript/TypeScript)ã§ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
* SDLã§ã¯schemaã¨resolverã®å®šç¾©ãŒåˆ†é›¢ã—ã¦ã„ãŸãŒã€Nexusã§ã¯2ã¤ã‚’åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
* SDLãƒ•ã‚¡ã‚¤ãƒ«ã¨å‹å®šç¾©ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãã‚Œã‚‹
* ã‚¨ãƒ‡ã‚£ã‚¿ã§è£œå®ŒãŒåŠ¹ã
* å‹æ¤œçŸ¥ã«ã‚ˆã‚Šã€Typoã¯ã€ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŸã‚ã€ã™ãæ°—ã¥ã

è©³ã—ãã¯å…¬å¼ãƒšãƒ¼ã‚¸ã‚’ã”è¦§ãã ã•ã„ã€‚

https://nexusjs.org/docs/getting-started/why-nexus

ãã‚Œã§ã¯ã€å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã¾ã—ã‚‡ã†ï¼

# nexusã‚’ä½¿ã£ã¦ã¿ã‚ˆã†

ã¾ãšã¯ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```sh
$ yarn add nexus
```


ã‚¹ã‚­ãƒ¼ãƒã¨ãƒªã‚¾ãƒ«ãƒãƒ¼ã‚’å®šç¾©ã—ã¦ã„ãã¾ã™ã€‚

```ts:types/Task.ts
import {
  objectType,
  extendType,
  nonNull,
  stringArg,
  intArg,
  booleanArg,
} from "nexus";

// å‹å®šç¾©
// ã‚¿ã‚¹ã‚¯ã®å‹
export const Task = objectType({
  name: "Task",
  description: "ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®å‹å®šç¾©",  // å„ç¨®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¬æ˜ã‚’descriptionã§è¨˜è¿°ã§ãã‚‹
  definition(t) {
    t.nonNull.int("id", { description: "ã‚¿ã‚¹ã‚¯ã®id" });
    t.nonNull.string("title", { description: "ã‚¿ã‚¹ã‚¯ã®ã‚¿ã‚¤ãƒˆãƒ«" });
    t.nonNull.boolean("done", { description: "å®Œäº†ãƒ•ãƒ©ã‚°" });
  },
});

// è¿”ã™ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
export const TasksQuery = extendType({
  type: "Query",
  definition(t) {
    t.nonNull.list.field("tasks", {
      description: "ã‚¿ã‚¹ã‚¯ä¸€è¦§é…åˆ—ã‚’è¿”ã™",
      type: "Task", // è¿”ã‚Šå€¤ã®å‹ã‚¿ã‚¤ãƒ—
      resolve(_parent, _args, ctx) {
        return [
          {
         ã€€  id: 1,
            title: 'task 1',
            done: false,
          },
          {
            id: 2,
            title: 'task 2',
            done: false,
          },
        ]
      },
    });
  },
});
```

å…¨ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

```ts:types/index.ts
export * from './Task'
```

è¨­å®šãªã©ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```ts:schema.ts
import { makeSchema } from 'nexus'
import { join } from 'path'
import * as types from './types/index'

export const schema = makeSchema({
  types,  // ã‚¹ã‚­ãƒ¼ãƒã¨ãƒªã‚¾ãƒ«ãƒãƒ¼ã®è¨­å®š
  outputs: {
    // å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’node_modules/@types/nexus-typegen/index.d.tsã«ç”Ÿæˆã™ã‚‹è¨­å®š
    typegen: join(process.cwd(), 'node_modules', '@types', 'nexus-typegen', 'index.d.ts'),
    // GraphQL SDLãƒ•ã‚¡ã‚¤ãƒ«ã‚’graphql/schema.graphqlã«ç”Ÿæˆã™ã‚‹è¨­å®š
    schema: join(process.cwd(), 'graphql', 'schema.graphql'),
  }
})
```

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’apollo serverã§è¨­å®š

```ts:index.ts
import { ApolloServer } from 'apollo-server-micro'
import { schema } from './schema';

// apolloserverã«ã‚¹ã‚­ãƒ¼ãƒãƒ¼ã¨ãƒªã‚¾ãƒ«ãƒãƒ¼ã®ã‚»ãƒƒãƒˆ
const server = new ApolloServer({
  schema,
  csrfPrevention: true,
});

// ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒªãƒƒã‚¹ãƒ³
server.listen().then(({ url }) => {
  console.log(`ğŸš€  Server ready at ${url}`);
});
```

å‹å®šç¾©ã¨ãƒªã‚¾ãƒ«ãƒãƒ¼ã®è¨˜è¿°ã¯`types/Task.ts`ã«æ›¸ã‹ã‚Œã¦ãŠã‚Šã€ã™ã£ãã‚Šã¨ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚å®Ÿè£…ã‚‚ã¨ã¦ã‚‚æ¥½ã«ãªã‚Šãã†ã§ã™ã€‚

èª¬æ˜ã‚‚descriptionã§æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚descriptionã«æ›¸ã‹ã‚ŒãŸèª¬æ˜ã¯ã€apollo studioã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ãã®èª¬æ˜ã‚’è¦‹ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚‚å®Ÿè£…ã§ãã‚‹ã®ã§ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã«ã‚‚ãªã‚Šã¾ã™ã­ã€‚

ã¾ãŸã€TypeScriptã‚’åˆ©ç”¨ã—ã€ã‚³ãƒ¼ãƒ‰è£œå®ŒãŒåŠ¹ããŸã‚ã€ã‚³ãƒ¼ãƒ‰ã‚‚ç´ æ—©ãæ›¸ã‘ã¾ã™ã€‚ã¾ãŸã€ã‚¿ã‚¤ãƒã‚‚ã™ãæ•™ãˆã¦ãã‚Œã¾ã™ã€‚ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªãƒŸã‚¹ã‚‚ã™ãã«ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```ts:types/Task.ts
      resolve(_parent, _args, ctx) {
        return [
          {
         ã€€  ip: 1,   // ã‚¨ãƒ©ãƒ¼ã§ã™
            title: 'task 1',
            done: false,
          },
          {
            id: 2,
            title: 'task 2',
            done: false,
          },
        ]
```

ä¾¿åˆ©ã§ã™ã­ï¼

ã¾ãŸã€`output`ã«è¨˜è¿°ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ãŒã€
ãƒ–ãƒ©ã‚¦ã‚¶ã§APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€apollo sutudioã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã‚‹(https://studio.apollographql.com/sandbox/explorer)ã®ã§ã€ãã“ã€€ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸçŠ¶æ…‹ã§ã€ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã™ã‚‹ã¨è‡ªå‹•çš„ã«ã€`schema.graphql`ã¨å‹å®šç¾©ãŒä½œæˆã•ã‚Œã¾ã™ã€‚ï¼ˆãªãœã€ã“ã‚Œã§ã§ãã‚‹ã®ã‹ã¾ã ã€ç†è§£ã§ãã¦ã„ã¾ã›ã‚“ã€‚ã€‚ï¼‰

# prismaã¨ã®åˆ©ç”¨

ã¾ãŸã€prismaã¨ã®ç›¸æ€§ã‚‚ã„ã„ã§ã™ã€‚ãƒªã‚¾ãƒ«ãƒãƒ¼ã¨ã—ã¦ã€prismaã‚’åˆ©ç”¨ã—ã¦ã€DBã®å€¤ã‚’è¿”ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```ts:prisma.ts
import { PrismaClient } from "@prisma/client";

declare global {
  var prisma: PrismaClient | undefined;
}

// prisma clientã‚’è¿”ã™
export const prisma =
  global.prisma ||
  new PrismaClient({
    log: ["query"],
  });

if (process.env.NODE_ENV !== "production") global.prisma = prisma;
```

```ts:context.ts
import { PrismaClient } from "@prisma/client";
import { prisma } from "./prisma";

export type Context = {
  prisma: PrismaClient;
};

/**
 * resolverãŒPrismaClientã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å€¤ã‚’å¤‰æ›ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€prisma clientã‚’è¿”ã™
 * @returns prismaClient
 */
export async function createContext(): Promise<Context> {
  return {
    prisma,
  };
}
```

```ts:schema.ts
import { makeSchema } from 'nexus'
import { join } from 'path'
import * as types from './types/index'

export const schema = makeSchema({
  types,  // ã‚¹ã‚­ãƒ¼ãƒã¨ãƒªã‚¾ãƒ«ãƒãƒ¼ã®è¨­å®š
  outputs: {
    // å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’node_modules/@types/nexus-typegen/index.d.tsã«ç”Ÿæˆã™ã‚‹è¨­å®š
    typegen: join(process.cwd(), 'node_modules', '@types', 'nexus-typegen', 'index.d.ts'),
    // GraphQL SDLãƒ•ã‚¡ã‚¤ãƒ«ã‚’graphql/schema.graphqlã«ç”Ÿæˆã™ã‚‹è¨­å®š
    schema: join(process.cwd(), 'graphql', 'schema.graphql'),
  },
+ contextType: {
+   // context.tsãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š
+   export: "Context",
+   module: join(process.cwd(), "context.ts"),
+ },
})
```

ãã†ã™ã‚‹ã¨ãƒªã‚¾ãƒ«ãƒãƒ¼ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã€‚

```ts:types/Task.ts
export const TasksQuery = extendType({
  type: "Query",
  definition(t) {
    t.nonNull.list.field("tasks", {
      description: "ã‚¿ã‚¹ã‚¯ä¸€è¦§é…åˆ—ã‚’è¿”ã™",
      type: "Task", // å¸°ã‚Šå€¤ã®å‹ã‚¿ã‚¤ãƒ—
      resolve(_parent, _args, ctx) {
+       return ctx.prisma.task.findMany(); // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å€¤ã‚’è¿”ã™
      },
    });
  },
});
```

è©³ã—ãã¯å…¬å¼ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ã”è¦§ã„ãŸã ãã¨ã„ã„ã§ã™ã€‚

https://github.com/graphql-nexus/nexus/tree/main/examples/with-prisma


# ã¾ã¨ã‚

ã©ã†ã§ã—ãŸã§ã—ã‚‡ã†ã‹ã€‚ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã«ã‹ã‘ã€TypeScriptã®æ©æµã‚‚å—ã‘ã‚Œã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ã¨ã¦ã‚‚æ¥½ã«ãªã‚Šã¾ã™ã€‚

GraphQLã‚’åˆ©ç”¨ã™ã‚‹éš›ã¯æ˜¯éç©æ¥µçš„ã«åˆ©ç”¨ã‚’æ¤œè¨ã—ãŸã„ãƒ„ãƒ¼ãƒ«ã§ã™ã­ã€‚

# å‚è€ƒ
https://zenn.dev/youichiro/articles/9e028d0a3b45e3
