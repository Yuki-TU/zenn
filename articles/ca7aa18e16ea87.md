---
title: "è¤‡æ•°åˆ—ã‚½ãƒ¼ãƒˆã«ãŠã‘ã‚‹ã‚«ãƒ¼ã‚½ãƒ«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…"
emoji: "ğŸ•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "go"
  - "pagination"
	- "sql"
	- "cursor"
published: false
---

ã“ã‚“ã«ã¡ã¯ã€@nerusan ã§ã™ã€‚

ä»Šå›ã¯ã€è¤‡æ•°åˆ—ã‚½ãƒ¼ãƒˆã«ãŠã‘ã‚‹ã‚«ãƒ¼ã‚½ãƒ«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã€èª¬æ˜ã—ã¾ã™ã€‚

# ã‚«ãƒ¼ã‚½ãƒ«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã¨ã¯ï¼Ÿ

ã‚«ãƒ¼ã‚½ãƒ«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¯ã‚¨ãƒªçµæœã‚’ãƒšãƒ¼ã‚¸ã”ã¨ã«å–å¾—ã™ã‚‹ãŸã‚ã®æ–¹æ³•ã§ã™ã€‚é€šå¸¸ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒšãƒ¼ã‚¸ç•ªå·ã‚„ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ãŒã€ã‚«ãƒ¼ã‚½ãƒ«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€å‰ã®ãƒšãƒ¼ã‚¸ã®æœ€å¾Œã®è¦ç´ ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’ä½¿ç”¨ã—ã¦æ¬¡ã®ãƒšãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚

ã‚«ãƒ¼ã‚½ãƒ«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®åˆ©ç‚¹ã¯ã€ãƒšãƒ¼ã‚¸ã®ç§»å‹•ãŒé«˜é€Ÿã§ã‚ã‚‹ã“ã¨ã§ã™ã€‚ãƒšãƒ¼ã‚¸ç•ªå·ã‚„ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ãƒšãƒ¼ã‚¸æ•°ãŒå¢—ãˆã‚‹ã«ã¤ã‚Œã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¯ã‚¨ãƒªãŒé…ããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€ã‚«ãƒ¼ã‚½ãƒ«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯å¸¸ã«ä¸€å®šã®é€Ÿåº¦ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã™ã€‚

å…·ä½“çš„ãªå®Ÿè£…æ–¹æ³•ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç¨®é¡ã‚„ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ãŒã€ä¸€èˆ¬çš„ã«ã¯ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ã‚«ãƒ¼ã‚½ãƒ«ã‚’æŒ‡å®šã—ã€ãã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’ä½¿ç”¨ã—ã¦æ¬¡ã®ãƒšãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚

ã‚«ãƒ¼ã‚½ãƒ«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŠ¹ç‡çš„ã«å–å¾—ã™ã‚‹ãŸã‚ã®æœ‰ç”¨ãªæ‰‹æ³•ã§ã™ã€‚ç‰¹ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„ãƒšãƒ¼ã‚¸ãƒ³ã‚°ã‚’è¡Œã†ã‚ˆã†ãªå ´åˆã«ã¯ã€æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚


# ã‚ªãƒ•ã‚»ãƒƒãƒˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒãªãœé…ããªã‚‹ã®ã‹ï¼Ÿ

ã‚ªãƒ•ã‚»ãƒƒãƒˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒãªãœãƒšãƒ¼ã‚¸æ•°ãŒãµãˆã‚‹ã«ã¤ã‚Œã¦é…ããªã‚‹ã®ã‹ã‚’ç°¡å˜ã«èª¬æ˜ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªã‚’è¦‹ã¦ãã ã•ã„ã€‚

```sh:mysql
mysql> explain select * from users order by id limit 2 offset 1000;
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------+
|  1 | SIMPLE      | users | NULL       | index | NULL          | PRIMARY | 8       | NULL | 1002 |   100.00 | NULL  |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------+
```

rowsã‚’æ³¨ç›®ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
2ä»¶ã‚’ã®ã¿ã‚’å–å¾—ã—ãŸã„ã®ã«ã€rowsã§ã¯ã€1002ä»¶ã¨ãªã‚Šã€å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å–å¾—ã•ã‚Œã‚‹è¡ŒãŒ1002ã«ãªã£ã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚Šã¾ã™ã€‚
ã“ã‚Œã¯ã€`limit 2 offset 1000`ã®éƒ¨åˆ†ãŒé–¢ä¿‚ã—ã¦ãŠã‚Šã€1000ä»¶ã¾ã§ã®ã‚½ãƒ¼ãƒˆã‚’ç¢ºèªã—ã€ãã“ã‹ã‚‰2ä»¶å–ã‚Šå‡ºã—ã¦ã„ã‚‹ãŸã‚ã€å…¨ä½“ã¨ã—ã¦1000+2=1002ä»¶ã®èª­ã¿å–ã‚ŠãŒç™ºç”Ÿã—ã¾ã™ã€‚

ã¤ã¾ã‚Šã€offsetãŒ100000ã§ã‚ã‚Œã°ã€100002ä»¶ãŒå–å¾—ã•ã‚Œã€ãƒšãƒ¼ã‚¸æ•°ãŒå¢—ãˆã‚‹æ—…ã«é…ããªã‚‹ã®ã§ã™ã€‚

# å®Ÿè£…

ãƒ¦ãƒ¼ã‚¶ãƒ¼é–“ãŒãƒã‚¤ãƒ³ãƒˆé€ä»˜ã—ã‚ã†ã‚¢ãƒ—ãƒªã‚’è€ƒãˆã‚‹ã¨ã—ã¾ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒã‚¤ãƒ³ãƒˆã‚’é€ä»˜ã™ã‚‹ã“ã¨ãŒã§ãã€é€ä»˜ã•ã‚ŒãŸåˆè¨ˆå€¤ãŒç²å¾—ãƒã‚¤ãƒ³ãƒˆã«ãªã‚Šã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤ºãƒšãƒ¼ã‚¸ãŒã‚ã‚Šã€ãã“ã§ã¯ã€ç„¡é™ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§è¡¨ç¤ºã™ã‚‹ã“ã¨ã‚’è€ƒãˆã‚‹ã¨ã—ã¾ã™ã€‚
ãã®éš›ã®ã‚½ãƒ¼ãƒˆã®è¦ä»¶ã¨ã—ã¦ã€ä»¥ä¸‹ã‚’æº€ãŸã™ã‚‚ã®ã¨ã—ã¾ã™ã€‚

- ç²å¾—ãƒã‚¤ãƒ³ãƒˆç²å¾—æ•°ã®é™é †
- ç²å¾—ãƒã‚¤ãƒ³ãƒˆãŒåŒã˜å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ—¥ã®æ˜‡é †
- ç²å¾—ãƒã‚¤ãƒ³ãƒˆã€ä½œæˆæ—¥ã‚‚åŒã˜å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®æ˜‡é †

## ãƒ†ãƒ¼ãƒ–ãƒ«

ä»¥ä¸‹ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ã€‚

```sql:schema.sql
CREATE TABLE `users` (
    `id`                      BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è­˜åˆ¥å­',
    `family_name`             VARCHAR(256) NOT NULL COMMENT 'è‹—å­—',
    `family_name_kana`        VARCHAR(256) NOT NULL COMMENT 'è‹—å­—ã‚«ãƒŠ',
    `first_name`              VARCHAR(256) NOT NULL COMMENT 'åå‰',
    `first_name_kana`         VARCHAR(256) NOT NULL COMMENT 'åå‰ã‚«ãƒŠ',
    `email`                   VARCHAR(256) NOT NULL COMMENT 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
    `password`                VARCHAR(256) NOT NULL COMMENT 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥',
    `sending_point`           INT NOT NULL COMMENT 'é€ä¿¡å¯èƒ½ãƒã‚¤ãƒ³ãƒˆ',
    `created_at`              DATETIME(6) NOT NULL COMMENT 'ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆæ—¥æ™‚',
    `update_at`               DATETIME(6) NOT NULL COMMENT 'ãƒ¬ã‚³ãƒ¼ãƒ‰ä¿®æ­£æ—¥æ™‚',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uix_email` (`email`) USING BTREE
) Engine=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ãƒ¦ãƒ¼ã‚¶ãƒ¼';

CREATE TABLE `transactions` (
    `id`                 BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'å–å¼•ã®è­˜åˆ¥å­',
    `sending_user_id`    BIGINT UNSIGNED NOT NULL COMMENT 'é€ä¿¡ãƒ¦ãƒ¼ã‚¶ã®ID',
    `receiving_user_id`  BIGINT UNSIGNED NOT NULL COMMENT 'å—ä¿¡ãƒ¦ãƒ¼ã‚¶ã®ID',
    `transaction_point`  INT NOT NULL COMMENT 'å–å¼•ãƒã‚¤ãƒ³ãƒˆ',
    `transaction_at`     DATETIME(6) NOT NULL COMMENT 'å–å¼•æ—¥æ™‚',
    PRIMARY KEY (`id`)
) Engine=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å–å¼•';
```


## Goã®ã‚³ãƒ¼ãƒ‰

```go:repository/users.go
type GetAllWithCursorParam struct {
	Size            int          `db:"size"`
	CursorPoint     int          `db:"point"`
	CursorUserID    model.UserID `db:"user_id"`
	CursorCreatedAt time.Time    `db:"created_at"`
}

// GetAllWithCursor ãƒã‚¤ãƒ³ãƒˆé †ã«ãƒ¦ãƒ¼ã‚¶ã‚’å–å¾—ã™ã‚‹
// ã‚«ãƒ¼ã‚½ãƒ«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦å–å¾—ã™ã‚‹
// ã‚½ãƒ¼ãƒˆé †ã¯ä»¥ä¸‹ã®é€šã‚Š
//
// 1. ãƒã‚¤ãƒ³ãƒˆãŒå¤šã„é †
// 2. ãƒã‚¤ãƒ³ãƒˆãŒåŒã˜å ´åˆã¯ç™»éŒ²æ—¥ãŒå¤ã„é †
// 3. ãƒã‚¤ãƒ³ãƒˆã¨ç™»éŒ²æ—¥ãŒåŒã˜å ´åˆã¯ãƒ¦ãƒ¼ã‚¶IDãŒå¤§ãã„é †
func (r *Repository) GetAllWithCursor(ctx context.Context, db Queryer, param GetAllWithCursorParam) ([]*entities.User, error) {
	sql := `
		WITH points AS (
			SELECT receiving_user_id AS user_id, SUM(transaction_point) AS point
			FROM transactions
			GROUP BY receiving_user_id
		)
		SELECT u.*
		FROM users AS u
		INNER JOIN points AS p
		ON u.id = p.user_id
		WHERE
		  p.point < ? 
			OR (p.point = ? AND u.created_at > ?) 
			OR (p.point = ? AND u.created_at = ? AND u.id > ?)
		ORDER BY p.point DESC, u.created_at ASC, u.id ASC
		LIMIT ?;`

	var users []*entities.User
	err := db.SelectContext(ctx, &users, sql,
		param.CursorPoint,
		param.CursorPoint,
		param.CursorCreatedAt,
		param.CursorPoint,
		param.CursorCreatedAt,
		param.CursorUserID,
		param.Size,
	)
	if err != nil {
		return users, errors.Wrap(err, "failed to get all users in user repo")
	}

	return users, nil
}

type GetUsersParam struct {
	Size int
}

// GetUsers ãƒã‚¤ãƒ³ãƒˆé †ã«ãƒ¦ãƒ¼ã‚¶ã‚’å–å¾—ã™ã‚‹
//
// ã‚½ãƒ¼ãƒˆé †ã¯ä»¥ä¸‹ã®é€šã‚Š
//
// 1. ãƒã‚¤ãƒ³ãƒˆãŒå¤šã„é †
// 2. ãƒã‚¤ãƒ³ãƒˆãŒåŒã˜å ´åˆã¯ç™»éŒ²æ—¥ãŒå¤ã„é †
// 3. ãƒã‚¤ãƒ³ãƒˆã¨ç™»éŒ²æ—¥ãŒåŒã˜å ´åˆã¯ãƒ¦ãƒ¼ã‚¶IDãŒå¤§ãã„é †
func (r *Repository) GetUsers(ctx context.Context, db Queryer, param GetUsersParam) ([]*entities.User, error) {
	sql := `
		WITH points AS (
			SELECT receiving_user_id AS user_id, SUM(transaction_point) AS point
			FROM transactions
			GROUP BY receiving_user_id
		)
		SELECT u.*
		FROM users AS u
		INNER JOIN points AS p
		ON u.id = p.user_id
		ORDER BY p.point DESC, u.created_at ASC, u.id ASC
		LIMIT ?;`

	var users []*entities.User
	err := db.SelectContext(ctx, &users, sql,
		param.Size,
	)
	if err != nil {
		return users, errors.Wrap(err, "failed to get all users in user repo")
	}

	return users, nil
}
```


```go:servce/get_users.go
package service

import (
	"context"
	"encoding/base64"
	"encoding/json"
	"time"

	"github.com/cockroachdb/errors"
	"github.com/hack-31/point-app-backend/domain"
	"github.com/hack-31/point-app-backend/domain/model"
	"github.com/hack-31/point-app-backend/repository"
	"github.com/hack-31/point-app-backend/repository/entities"
	"github.com/jmoiron/sqlx"
)

type GetUsers struct {
	DB              repository.Queryer
	UserRepo        domain.UserRepo
	TransactionRepo domain.TransactionRepo
	TokenGenerator  domain.TokenGenerator
}

func NewGetUsers(db *sqlx.DB, repo *repository.Repository, jwter domain.TokenGenerator) *GetUsers {
	return &GetUsers{
		DB:              db,
		UserRepo:        repo,
		TransactionRepo: repo,
		TokenGenerator:  jwter,
	}
}

type GetUsersRequest struct {
	Size       int
	NextCursor string
}

type GetUsersResponse struct {
	Users []struct {
		ID               model.UserID
		FirstName        string
		FirstNameKana    string
		FamilyName       string
		FamilyNameKana   string
		Email            string
		AcquisitionPoint int
	}
	NextCursor string
}


// ãƒ¦ãƒ¼ã‚¶ä¸€è¦§å–å¾—ã‚µãƒ¼ãƒ“ã‚¹
//
// @params ctx ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
//
// @return
// ãƒ¦ãƒ¼ã‚¶ä¸€è¦§
func (r *GetUsers) GetUsers(ctx context.Context, input GetUsersRequest) (GetUsersResponse, error) {
	// ãƒ¦ãƒ¼ã‚¶ä¸€è¦§ã‚’å–å¾—ã™ã‚‹
	type cursor struct {
		UserID    model.UserID `json:"user_id"`
		Point     int          `json:"point"`
		CreatedAt time.Time    `json:"created_at"`
	}
	var users []*entities.User
	var c cursor
  // ï¼’å›ç›®ä»¥é™ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
	if input.NextCursor != "" {
    // base64ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ã€JSONã‚’æ§‹é€ ä½“ã«ãƒãƒƒãƒ”ãƒ³ã‚°
		data, err := base64.URLEncoding.DecodeString(input.NextCursor)
		if err != nil {
			return GetUsersResponse{}, errors.Wrap(err, "failed to decode nextCursor in GetUsersService.GetUsers")
		}
		if err := json.Unmarshal(data, &c); err != nil {
			return GetUsersResponse{}, errors.Wrap(err, "failed to unmarshal nextCursor in GetUsersService.GetUsers")
		}
    // ã‚«ãƒ¼ã‚½ãƒ«ã‚’ã‚‚ã¨ã«ã€æ¬¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’å–å¾—
		users, err = r.UserRepo.GetAllWithCursor(ctx, r.DB, repository.GetAllWithCursorParam{
			Size:            input.Size,
			CursorPoint:     c.Point,
			CursorUserID:    c.UserID,
			CursorCreatedAt: c.CreatedAt,
		})
		if err != nil {
			return GetUsersResponse{}, errors.Wrap(err, "failed to get users in GetUsersService.GetUsers")
		}
	}
  // åˆå›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
	if input.NextCursor == "" {
		var err error
		if input.Size == 0 {
			input.Size = 10
		}
    // åˆå›ã¯ã‚«ãƒ¼ã‚½ãƒ«ã¯ãªã„ã®ã§ã€ã‚½ãƒ¼ãƒˆã—ã¦ã€ä¸Šä½ã®ã‚µã‚¤ã‚ºåˆ†ã‚’å–å¾—
		users, err = r.UserRepo.GetUsers(ctx, r.DB, repository.GetUsersParam{
			Size: input.Size,
		})
		if err != nil {
			return GetUsersResponse{}, errors.Wrap(err, "failed to get users in GetUsersService.GetUsers")
		}
	}
	if len(users) == 0 {
		return GetUsersResponse{
			Users: []struct {
				ID               model.UserID
				FirstName        string
				FirstNameKana    string
				FamilyName       string
				FamilyNameKana   string
				Email            string
				AcquisitionPoint int
			}{},
			NextCursor: "",
		}, nil
	}

	// ãƒ¦ãƒ¼ã‚¶IDsã‚’å–å¾—ã™ã‚‹
	userIDs := make([]model.UserID, 0, len(users))
	for _, user := range users {
		userIDs = append(userIDs, model.UserID(user.ID))
	}

	// å–å¾—ãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹
	points, err := r.TransactionRepo.GetAquistionPoint(ctx, r.DB, userIDs)
	if err != nil {
		return GetUsersResponse{}, errors.Wrap(err, "failed to get points in GetUsersService.GetUsers")
	}

	res := make([]struct {
		ID               model.UserID
		FirstName        string
		FirstNameKana    string
		FamilyName       string
		FamilyNameKana   string
		Email            string
		AcquisitionPoint int
	}, 0, len(users))

	// ãƒ¦ãƒ¼ã‚¶ã«å–å¾—ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã™ã‚‹
	for _, v := range users {
		res = append(res, struct {
			ID               model.UserID
			FirstName        string
			FirstNameKana    string
			FamilyName       string
			FamilyNameKana   string
			Email            string
			AcquisitionPoint int
		}{
			ID:               model.UserID(v.ID),
			FirstName:        v.FirstName,
			FirstNameKana:    v.FirstNameKana,
			FamilyName:       v.FamilyName,
			FamilyNameKana:   v.FamilyNameKana,
			Email:            v.Email,
			AcquisitionPoint: points[model.UserID(v.ID)],
		})
	}
	var nextCursorStr string
  // å–å¾—ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚µã‚¤ã‚ºæ•°ãŒåŒã˜å ´åˆã€
  // æ¬¡ã®ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€ã‚«ãƒ¼ã‚½ãƒ«ã‚’ä½œæˆã™ã‚‹
	if len(users) == input.Size {
    // JSONã«ã—ã¦ã€base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã™
		data, err := json.Marshal(cursor{
			UserID:    model.UserID(users[len(users)-1].ID),
			Point:     points[model.UserID(users[len(users)-1].ID)],
			CreatedAt: users[len(users)-1].CreatedAt,
		})
		if err != nil {
			return GetUsersResponse{}, errors.Wrap(err, "failed to marshal nextCursor in GetUsersService.GetUsers")
		}
		nextCursorStr = base64.URLEncoding.EncodeToString(data)
	}

	return GetUsersResponse{
		Users:      res,
		NextCursor: nextCursorStr,
	}, nil
}
```

è©³ã—ãã¯ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜ã‚’è¦‹ã¦ã‚‚ã‚‰ãˆãŸã‚‰ã¨æ€ã„ã¾ã™ãŒã€
ç°¡å˜ã«èª¬æ˜ã—ã¾ã™ã€‚

ã‚«ãƒ¼ã‚½ãƒ«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã‚«ãƒ¼ã‚½ãƒ«ã¨ã„ã†ã‚‚ã®ã‚’ä½¿ã„ã¾ã™ã€‚
ã‚«ãƒ¼ã‚½ãƒ«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ã€Œã‚«ãƒ¼ã‚½ãƒ«ã€ã¨ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚„APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹éš›ã«ä½¿ç”¨ã•ã‚Œã‚‹ä¸€ç¨®ã®ãƒãƒ¼ã‚«ãƒ¼ã‚„å‚ç…§ç‚¹ã®ã“ã¨ã§ã™ã€‚ã“ã®ã‚«ãƒ¼ã‚½ãƒ«ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå†…ã®ç¾åœ¨ã®ä½ç½®ã‚’ç¤ºã—ã€æ¬¡ã®ãƒšãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

repository.GetAllWithCursoré–¢æ•°ã§ã¯ã€ã‚«ãƒ¼ã‚½ãƒ«ã¨ã—ã¦æ¸¡ã•ã‚ŒãŸcursorPointã€cursorCreateAtã€cursorUserIDã‚’åŸºã«ã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
ã‚«ãƒ¼ã‚½ãƒ«ã¯ã€ORDER BYã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ pointã€created_atã€idãŒå¯¾è±¡ã«ãªã‚Šã¾ã™ã€‚
ã¾ãŸã€ã‚«ãƒ¼ã‚½ãƒ«ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€ä»˜ã•ã‚Œã‚‹ã“ã¨ã‚’ä»®å®šã—ã€ã‚½ãƒ¼ãƒˆé †ã®æœ€å¾Œã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å€¤ã«ãªã‚Šã¾ã™ã€‚
ã“ã®ã‚¯ã‚¨ãƒªã¯ã€æ¬¡ã®æ¡ä»¶ã‚’æº€ãŸã™ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¾ã™ï¼š

1. pointãŒcursorPointã‚ˆã‚Šå°ã•ã„
2. ã¾ãŸã¯ã€pointãŒcursorPointã¨ç­‰ã—ãã€create_atãŒcursorCreateAtã‚ˆã‚Šå¤§ãã„
3. ã¾ãŸã¯ã€pointãŒcursorPointã¨ç­‰ã—ãã€create_atãŒcursorCreateAtã¨ç­‰ã—ãã€idãŒidcursorUserIDã‚ˆã‚Šå¤§ãã„

ã“ã®æ¡ä»¶ã‚’ä»˜ã‘åŠ ãˆã‚‹ã“ã¨ã§ã€ã‚«ãƒ¼ã‚½ãƒ«ã§æŒ‡å®šã•ã‚ŒãŸå€¤ã‚ˆã‚Šã‚‚å¾Œã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’æŠ½å‡ºã§ãã¾ã™ã€‚
ã“ã®å ´åˆã€point, create_atãªã©ãŒé‡è¤‡ã™ã‚‹å ´åˆã§ã‚‚é©åˆ‡ã«æŠ½å‡ºã—ã¦ãã‚Œã¾ã™ã€‚
å°‘ã—æ¡ä»¶ã¨ã—ã¦ã¯è¤‡é›‘ãã†ã«è¦‹ãˆã¾ã™ãŒã€ã‚ˆãè€ƒãˆã‚‹ã¨ã€æ­£ã—ã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚

|points.point|user.created_at|user.id|
|---|---|---|
|112|2020-10-9|80|
|110|2020-10-10|8|
|100|2020-10-10|1|
|100|2020-10-10|2|
|100|2020-10-10|3|
|90|2020-10-10|30|

ã‚«ãƒ¼ã‚½ãƒ«ãŒã®å€¤ãŒ

- cursorPoint: 100
- cursorCretedAt: 2020-10-10
- cursorUserID: 1

ã®å ´åˆã€ä»¥ä¸‹ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒæŠ½å‡ºã•ã‚Œã¦ã€ã†ã¾ãæŠ½å‡ºã§ãã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚Šã¾ã™ã€‚


|points.point|user.created_at|user.id|
|---|---|---|
|100|2020-10-10|2|
|100|2020-10-10|3|
|90|2020-10-10|30|

ã‚½ãƒ¼ãƒˆã®å„ªå…ˆé †ä½ã€æ˜‡é †ã€é™é †ã§WHEREå¥ã®ã‚¯ã‚¨ãƒªã®çµ„ã¿ç«‹ã¦ãŒç•°ãªã‚‹ã®ã§æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚

service.GetUsersé–¢æ•°ã§ã¯ã€repository.GetAllWithCursoré–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚ã¾ãŸã€æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ã‚«ãƒ¼ã‚½ãƒ«å€¤ã‚’ã‚½ãƒ¼ãƒˆé †ã®æœ€å¾Œã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰è¨­å®šã—ã€æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

ã‚«ãƒ¼ã‚½ãƒ«ã®ä½œæˆã¯ã€JSONã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãŠã‚ˆã³Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

JSONã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã¨Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®çµ„ã¿åˆã‚ã›ã‚’ä½¿ã†ã“ã¨ã§ã€å®‰å…¨ã‹ã¤åŠ¹ç‡çš„ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’å–ã‚Šæ‰±ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

{"user_id":46,"point":3300,"created_at":"2024-03-11T00:18:37.116025+09:00"}
â‡©base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
eyJ1c2VyX2lkIjo0NiwicG9pbnQiOjMzMDAsImNyZWF0ZWRfYXQiOiIyMDI0LTAzLTExVDAwOjE4OjM3LjExNjAyNSswOTowMCJ9

ãŸã ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæŒ‡å®šã•ã‚ŒãŸsizeã‚ˆã‚Šã‚‚å–å¾—æ•°ãŒå°‘ãªã„å ´åˆã¯ã€æ¬¡ã®ãƒšãƒ¼ã‚¸ã¯ãªã„ã®ã§ã€nextTokenã¯è¿”å´ã—ã¾ã›ã‚“ã€‚


å…¨ä½“ã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ãŠã„ã¦ã„ã¾ã™ã®ã§ã€å‚è€ƒã«ã—ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

https://github.com/hack-31/point-app-backend


# ã¾ã¨ã‚

ã‚«ãƒ¼ã‚½ãƒ«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦è¨˜è¼‰ã—ã¾ã—ãŸã€‚
æœ€è¿‘ã‚ˆãè¦‹ã‚‹ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ–¹æ³•ãªã®ã§ã€ã—ã£ã‹ã‚ŠæŠ¼ã•ãˆã¦ãŠãã¾ã—ã‚‡ã†ã€‚
